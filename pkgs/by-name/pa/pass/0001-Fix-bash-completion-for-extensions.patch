From 463f98e5d904e9326f5f21980576a429ed9e4db8 Mon Sep 17 00:00:00 2001
From: Yury Shvedov <mestofel13@gmail.com>
Date: Tue, 9 Dec 2025 18:49:42 +0300
Subject: [PATCH] Fix bash completion for extensions

---
 man/pass.1                          |  3 +++
 src/completion/pass.bash-completion | 21 ++++++++++++++++++++-
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/man/pass.1 b/man/pass.1
index a555dcb..19a1dba 100644
--- a/man/pass.1
+++ b/man/pass.1
@@ -456,6 +456,9 @@ This environment variable must be set to "true" for extensions to be enabled.
 The location to look for executable extension files, by default
 \fIPASSWORD_STORE_DIR/.extensions\fP.
 .TP
+.I PASSWORD_STORE_EXTENSION_COMMANDS
+Array to hold commands added by extensions.
+.TP
 .I PASSWORD_STORE_SIGNING_KEY
 If this environment variable is set, then all \fB.gpg-id\fP files and non-system extension files
 must be signed using a detached signature using the GPG key specified by the full 40 character
diff --git a/src/completion/pass.bash-completion b/src/completion/pass.bash-completion
index 2d23cbf..12f8964 100644
--- a/src/completion/pass.bash-completion
+++ b/src/completion/pass.bash-completion
@@ -87,7 +87,8 @@ _pass()
 	local commands="init ls find grep show insert generate edit rm mv cp git help version ${PASSWORD_STORE_EXTENSION_COMMANDS[*]}"
 	if [[ $COMP_CWORD -gt 1 ]]; then
 		local lastarg="${COMP_WORDS[$COMP_CWORD-1]}"
-		case "${COMP_WORDS[1]}" in
+		local command="${COMP_WORDS[1]}"
+		case "${command}" in
 			init)
 				if [[ $lastarg == "-p" || $lastarg == "--path" ]]; then
 					_pass_complete_folders
@@ -123,6 +124,24 @@ _pass()
 			git)
 				COMPREPLY+=($(compgen -W "init push pull config log reflog rebase" -- ${cur}))
 				;;
+			*)
+				# To add completion for an extension command define a function like this:
+				# __password_store_extension_complete_<COMMAND>() {
+				#     COMPREPLY+=($(compgen -W "-o --option" -- ${cur}))
+				#     _pass_complete_entries 1
+				# }
+				#
+				# and add the command to the $PASSWORD_STORE_EXTENSION_COMMANDS array
+				local extension_completion_func="__password_store_extension_complete_${command}"
+				if [[ " ${PASSWORD_STORE_EXTENSION_COMMANDS[*]} " == *" ${command} "* ]]; then
+					if ! type "${extension_completion_func}" &> /dev/null && type _completion_loader &> /dev/null; then
+						_completion_loader "pass-${command}"
+					fi
+					if type "${extension_completion_func}" &> /dev/null; then
+						"${extension_completion_func}"
+					fi
+				fi
+				;;
 		esac
 
 		# To add completion for an extension command define a function like this:
-- 
2.51.2

